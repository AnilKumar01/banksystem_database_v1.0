USE BANK_SYSTEM

DELIMITER //

DROP PROCEDURE IF EXISTS ACTIVATE_CREDIT_CARD;
CREATE PROCEDURE ACTIVATE_CREDIT_CARD
(
	IN P_CREDIT_CARD_NO VARCHAR(30),
	IN P_ACCOUNT_NO VARCHAR(20),
	OUT P_STATUS INT
)
BEGIN
	DECLARE V_CNT INT;
	SELECT COUNT(*) INTO V_CNT FROM CREDIT_CARD WHERE CREDIT_CARD_NO=P_CREDIT_CARD_NO AND ACTIVATION_DATE IS NULL AND DEACTIVATION_DATE IS NULL;
	
	SET P_STATUS=V_CNT;
	
	IF V_CNT=1 THEN
		UPDATE CREDIT_CARD
		SET ACCOUNT_NO=P_ACCOUNT_NO, ACTIVATION_DATE=NOW()
		WHERE CREDIT_CARD_NO=P_CREDIT_CARD_NO;
		
		UPDATE ACCOUNT
		SET CREDIT_CARD="YES"
		WHERE ACCOUNT_NO=P_ACCOUNT_NO;
	END IF;
END;
//
