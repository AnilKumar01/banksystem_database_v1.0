USE BANK_SYSTEM

DELIMITER //

DROP PROCEDURE IF EXISTS ACTIVATE_DEBIT_CARD;
CREATE PROCEDURE ACTIVATE_DEBIT_CARD
(
	IN P_DEBIT_CARD_NO VARCHAR(30),
	IN P_ACCOUNT_NO VARCHAR(20),
	OUT P_STATUS INT
)
BEGIN
	DECLARE V_CNT INT;
	SELECT COUNT(*) INTO V_CNT FROM DEBIT_CARD WHERE DEBIT_CARD_NO=P_DEBIT_CARD_NO AND ACTIVATION_DATE IS NULL AND DEACTIVATION_DATE IS NULL;
	
	SET P_STATUS=V_CNT;
	
	IF V_CNT=1 THEN
		UPDATE DEBIT_CARD
		SET ACCOUNT_NO=P_ACCOUNT_NO, ACTIVATION_DATE=NOW()
		WHERE DEBIT_CARD_NO=P_DEBIT_CARD_NO;
		
		UPDATE ACCOUNT
		SET DEBIT_CARD="YES"
		WHERE ACCOUNT_NO=P_ACCOUNT_NO;
	END IF;
END;
//
